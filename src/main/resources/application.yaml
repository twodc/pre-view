spring:
  application:
    name: pre-view

  # 가상 스레드 활성화 (Java 21+)
  threads:
    virtual:
      enabled: true

  jackson:
    deserialization:
      fail-on-unknown-properties: false

  config:
    import: optional:file:.env[.properties]

  # Spring Security OAuth2 설정
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope: email, profile

  # Redis 설정
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}

  datasource:
    url: ${MYSQL_URL}
    username: ${MYSQL_USERNAME}
    password: ${MYSQL_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver

  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
        show_sql: true
    database-platform: org.hibernate.dialect.MySQLDialect

  ai:
    # Groq API 설정 (OpenAI 호환 API 사용)
    openai:
      api-key: ${GROQ_API_KEY}
      base-url: https://api.groq.com/openai
      chat:
        options:
          model: llama-3.3-70b-versatile
          temperature: 0.5
          max-tokens: 800

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
    try-it-out-enabled: true
  api-docs:
    path: /api-docs
  default-produces-media-type: application/json
  default-consumes-media-type: application/json
  use-management-port: false

logging:
  level:
    root: INFO
    com.example.pre_view: DEBUG
    # 인증 관련 로그 (운영 환경에서는 INFO로 변경)
    com.example.pre_view.domain.auth: DEBUG
    # Spring Security 로그 (디버깅 시에만 DEBUG)
    org.springframework.security: INFO
    org.springframework.web: INFO
    org.hibernate: WARN
    # Redis 연결 로그
    io.lettuce.core: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# JWT 설정
jwt:
  secret: ${JWT_SECRET}
  access-expiration: 900000      # 15분 (밀리초)
  refresh-expiration: 604800000  # 7일 (밀리초)

# 애플리케이션 설정
app:
  oauth2:
    redirect-uri: ${OAUTH2_REDIRECT_URI:http://localhost:3000/oauth/callback}
  cookie:
    secure: ${COOKIE_SECURE:false}       # 프로덕션에서는 true (HTTPS)
    same-site: ${COOKIE_SAME_SITE:Lax}   # Strict, Lax, None
    domain: ${COOKIE_DOMAIN:}            # 서브도메인 공유 시 설정

# ============================================
# Actuator 관측성 설정 (프로덕션 기본값 - 최소 노출)
# 로컬 개발: --spring.profiles.active=local 로 전체 노출
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health # info 제외 (보안 강화)
      base-path: /actuator
  endpoint:
    health:
      show-details: never  # 프로덕션: 상세 정보 숨김
      show-components: never
      probes:
        enabled: true  # Kubernetes liveness/readiness 지원
    prometheus:
      enabled: true
  health:
    circuitbreakers:
      enabled: true  # Resilience4j CircuitBreaker 상태 표시
    redis:
      enabled: true
    db:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        http.server.requests: true  # 응답 시간 히스토그램
      percentiles:
        http.server.requests: 0.5, 0.75, 0.95, 0.99  # 백분위수
  prometheus:
    metrics:
      export:
        enabled: true

resilience4j:
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 1s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2.0
        enableRandomizedWait: true
        randomizedWaitFactor: 0.5
        retryExceptions:
          - java.lang.Exception
    instances:
      aiServiceRetry:
        baseConfig: default
  circuitbreaker:
    instances:
      groqApi:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED # 횟수 기반 (직관적임)
        slidingWindowSize: 10          # 최근 10번 요청을 기준으로
        minimumNumberOfCalls: 5        # 최소 5번은 요청이 와야 계산
        failureRateThreshold: 50       # 50% 이상 실패하면 (5번 중 3번 실패 시)
        waitDurationInOpenState: 10s   # 10초 동안 차단 (Open)
        permittedNumberOfCallsInHalfOpenState: 3 # 10초 뒤 3번만 찔러보기